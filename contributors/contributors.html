<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="dataStore.js"></script>
    <script src="jquery-2.1.1.min.js"></script>
    <script src="handlebars-v2.0.0.js"></script>
    <title></title>
</head>
<body>
<script>

var data = window.localStorage.getItem("data");

if (data){
    data = JSON.parse(data);
} else {
    data = dataStore;
}

window.onload = function(){
    render();
}

window.onunload = function unload (argument) {
    var data = getData();
    window.localStorage.setItem("data", JSON.stringify(data));
}

function saveToDisk(){
    download("dataStore.js","var dataStore = " + JSON.stringify(getData(),  null, '\t'));
}

function download(filename, text) {
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    pom.setAttribute('download', filename);
    pom.click();
}

function render (){
    var nodeSpeakerTable = document.getElementById("speakerTable");
    var source   = $("#table-template").html();
    var template = Handlebars.compile(source);
    var html = template({
        data: data
    });
    nodeSpeakerTable.innerHTML = html;
}

function getData(){
    var data = [];
    var trNodes = document.getElementsByTagName("tr");
    for (var i = 0; i < trNodes.length; i++){
        var rowNode = trNodes[i];
        var name = rowNode.getElementsByClassName("name")[0].innerText;
        var ruName = rowNode.getElementsByClassName("ruName")[0].innerText;
        var talks = rowNode.getElementsByClassName("talks")[0].innerText.split(";");
        data.push({
            name: name.trim(),
            ruName: ruName.trim(),
            talks: talks.map(function(item){
                return {title: item.trim()}
            }).filter(function(item){
                return !!item.title.trim();
            }),
            imagePath: name.trim().replace(" ", "_").toLowerCase() + ".jpg"
        })
    }
    data.sort(function(speakerA, speakerB){
        if (speakerB.talks.length == speakerA.talks.length) {
            if (speakerA.name < speakerB.name) {
                return -1;
            }
            if (speakerA.name > speakerB.name) {
                return 1;
            }
            return 0;
        } else {
            return speakerB.talks.length - speakerA.talks.length;
        }
    })
    return data;
}

function renderHTML(){
    var source   = $("#entry-template").html();
    var template = Handlebars.compile(source);
    var html = template({
        data: getData()
    });
    var textArea = document.createElement("textarea");
    textArea.innerHTML = html;
    document.body.appendChild(textArea);
}
</script>

<script id="table-template" type="text/x-handlebars-template">
    <thead>
        <th>Name (image src)</th>
        <th>ФИО</th>
        <th>Доклады</th>
    </thead>
    <tbody>
  {{#each data}}
    <tr>
        <td class='name' contentEditable>{{name}}</td>
        <td class='ruName' contentEditable>{{ruName}}</td>
        <td class='talks' contentEditable>
            {{#each talks}}
                {{title}};
            {{/each}}
        </td>
    </tr>
  {{/each}}
    </tbody>
</script>

<script id="entry-template" type="text/x-handlebars-template">
<ul class="speaker-list">
  {{#each data}}
    <li>
        <img class="speaker-photo" src="images/speakers/{{imagePath}}" alt="{{ruName}}" />
        <h3>{{ruName}}</h3>
        {{#each talks}}
            <p class="report">{{title}}</p>
        {{/each}}
    </li>
  {{/each}}
</ul>
</script>
<button onclick="renderHTML();">Render HTML</button>
<button onclick="saveToDisk();">Create dataStore.js</button>
<table width="100%" rules="all" id="speakerTable"></table>
</body>
</html>